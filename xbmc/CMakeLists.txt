cmake_minimum_required(VERSION 2.8)

set(TARGET "i686-pc-linux-gnu")
set(TARGET_DIR "${SYSROOT}/usr/local")

include(ExternalProject)



file(WRITE ${CMAKE_BINARY_DIR}/xbmc_configure_helper.sh
"
#!/bin/sh
PF=`${SYSROOT}/usr/bin/${TARGET}-pkg-config --libs python`
export LDFLAGS=\"-L${TARGET_DIR}/lib -lgcc -lm -ltinyxml -lgdl -lismd_core -lismd_viddec -lismd_vidpproc -lismd_audio -lismd_vidrend -lismd_demux -losal -lplatform_config\"
export CFLAGS=\"-DTARGET_BOXEE=1 -DTIXML_USE_STL -I${TARGET_DIR}/include -DHAS_INTEL_SMD\"
export CXXFLAGS=\"$CFLAGS\"
export FREETYPE2_CFLAGS=\"-I${TARGET_DIR}/include/freetype2\"
export PYTHON_VERSION=\"2.7.2\"
export PYTHON_NOVERSIONCHECK=\"y\"
export PYTHON=\"${TARGET_DIR}/bin/python\"
export PYTHON_CPPFLAGS=\"-I${TARGET_DIR}/include/python2.7\"
export PYTHON_LDFLAGS=\"\$PF -ldl -lpthread -lutil\"
../xbmc/configure --prefix=${TARGET_DIR} --host=${TARGET} --disable-gl --disable-sdl --disable-mysql --disable-x11 --disable-samba  --with-arch=i686 --with-platform=linux --enable-gles --enable-external-libraries --disable-joystick --enable-debug --disable-texturepacker
"
)
execute_process(COMMAND chmod +x ${CMAKE_BINARY_DIR}/xbmc_configure_helper.sh)

add_custom_target(
	copydeps ALL
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/windowing/egl/EGLNativeTypeBoxee.cpp                 ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/windowing/egl/EGLNativeTypeBoxee.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/windowing/egl/EGLNativeTypeBoxee.h                   ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/windowing/egl/EGLNativeTypeBoxee.h
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/IntelSMDGlobals.cpp                            ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/IntelSMDGlobals.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/IntelSMDGlobals.h                              ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/IntelSMDGlobals.h
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/VideoRenderers/IntelSMDRenderer.cpp            ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/VideoRenderers/IntelSMDRenderer.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/VideoRenderers/IntelSMDRenderer.h              ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/VideoRenderers/IntelSMDRenderer.h
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.cpp    ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.h      ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.h
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.cpp ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.h   ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.h
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecSMD.cpp ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecSMD.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecSMD.h   ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecSMD.h
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/AudioEngine/Sinks/AESinkIntelSMD.cpp           ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/AudioEngine/Sinks/AESinkIntelSMD.cpp
	COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/AudioEngine/Sinks/AESinkIntelSMD.h             ${CMAKE_BINARY_DIR}/xbmc-prefix/src/xbmc/xbmc/cores/AudioEngine/Sinks/AESinkIntelSMD.h
)

# Note to self: xbmc.patch generated by:
#     diff -x generated -w -r -u xbmc-12.2 xbmc | grep -v '^Only in' > /Volumes/Skivavbild/boxee-xbmc/xbmc/xbmc.patch
ExternalProject_Add(
	xbmc
	URL 				http://mirrors.xbmc.org/releases/source/xbmc-12.2.tar.gz
	URL_MD5 			489f3877decae4e265ece54f9eaef0ba
	PATCH_COMMAND		patch -p1 -N < ${CMAKE_SOURCE_DIR}/xbmc.patch
	CONFIGURE_COMMAND	${CMAKE_BINARY_DIR}/xbmc_configure_helper.sh 
	BUILD_COMMAND 		make ${PARALLEL}
	BUILD_IN_SOURCE 	1
)
add_dependencies(xbmc copydeps)
